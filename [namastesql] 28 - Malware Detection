LINK: https://www.namastesql.com/coding-problem/28-malware-detection?question_type=0&complete_status=0

==> My approach:
--Filter IDs with number of detected malwares of at least 10 in the latest run & at least 2 runs in total
WITH LatestRun AS (
  SELECT software_id      
       , MAX(run_date) AS latest_run
  FROM malware
  GROUP BY software_id
       )
   , RunCount AS (
  SELECT l.software_id
       , l.latest_run
       , m.run_date
       , m.malware_detected
       , COUNT(*) OVER (PARTITION BY m.software_id) AS run_count
       , CASE WHEN l.latest_run = m.run_date THEN malware_detected
              ELSE NULL
         END AS latest_run_count
  FROM LatestRun AS l
  JOIN malware AS m
       ON l.software_id = m.software_id
     )
  , VerifiedID AS (
    SELECT * 
    FROM RunCount 
    WHERE run_count >= 2 
         AND latest_run_count >= 10
         AND latest_run_count IS NOT NULL
    )
--Get the sencond latest run count
  , RunOrder AS (
    SELECT *
         , ROW_NUMBER() OVER (PARTITION BY software_id ORDER BY run_date DESC) AS order_run
    FROM malware
    )
  , SecondLastRun AS (
    SELECT software_id      
         , malware_detected 
         , order_run
    FROM RunOrder
    WHERE order_run = 2
    )
--Merge data to get latest run count and difference to second latest one
    SELECT v.software_id      
         , v.latest_run_count  
         , v.latest_run_count - s.malware_detected AS difference_to_previous
    FROM VerifiedID AS v 
    JOIN SecondLastRun AS s
    ON v.software_id = s.software_id;  
    
